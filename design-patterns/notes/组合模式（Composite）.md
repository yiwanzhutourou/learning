# 组合模式（Composite）

## 意图

> Compose objects into tree structure to represent part-whole hierarchies. Composite lets clients treat individual objects and compositions of objects uniformly.
>
> 将对象组合为表示部分和整体层级关系的树形结构。组合模式可以使客户端用一致的方式对待单个对象和对象的组合。

一般图形化的组件都是树形化的组织结构，例如 Android 中的各种容器（`ViewGroup`） `LinearLayout`、`RelativeLayout` 等都继承自 `View`，一个 `ViewGroup` 可以包含各种基础组件，例如 `TextView`、`Button` 等，也可以包含其他 `ViewGroup`，基础组件也都继承自 `View`。Android 界面组件最终呈现在屏幕上都经过了测量、布局和绘制三个阶段，整个界面的外围容器只需要知道自己的根节点是一个 `View` 而不需要关心它具体是一个基础组件还是一个容器组件，这个根节点相当于这个树形结构的根，调用这个根节点的相应方法，它会再**递归地**调用它的子节点的相应方法，最终完成测量、布局和绘制的过程。一个可能的 Androud 组件树形结构如下图所示：

![Android View 树形结构](https://youdu-markdown.oss-cn-shanghai.aliyuncs.com/20191206175508.png)

## 适用场景

- 当你希望呈现对象的部分和整体的层级关系的时候。
- 当你希望客户端忽视单独的对象和对象的组合的不同的时候。客户端可以用一致的方式对待一个树形结构里的对象。

## 结构图

![组合模式结构图](https://youdu-markdown.oss-cn-shanghai.aliyuncs.com/20191206180220.png)

一个典型的组合结构如下图所示：

![典型的组合结构](https://youdu-markdown.oss-cn-shanghai.aliyuncs.com/20191206180219.png)

## 参与角色

- Component（`View`）

  - 定义组合中对象的接口
  - 可以在 Component 中实现默认行为
  - 定义管理子节点的接口
  - （可选的）定义获取父节点的接口

- Leaf（`TextView`, `Button`）

  - 表示叶子节点，叶子节点没有子节点
  - 定义组合中子节点的行为

- Composite（`ViewGroup`）

  - 表示非叶子节点

  - 定义组合中非子节点的行为
  - 存储子节点
  - 实现管理子节点的接口

- Client（`Activity`, `Fragment`）

  - 操作组合中的对象

## 流程

客户端使用 `Component` 暴露的接口与组合中的对象交互。如果调用的是叶子节点的方法，那么叶子节点直接处理这个请求；如果调用的是非叶子节点的方法，那么一般情况下，非叶子节点会继续调用它的子节点的相应方法，并在前后加上自己的逻辑。

## 结果

- 定义了一个树形结构，基础组件可以组合成为复杂组件，复杂组件可以和其他复杂组件或者基础组件进一步组合为新的复杂组件。
- 客户端的逻辑可以很简单。一般情况下，组合结构应该相对客户端是透明的，即客户端不用区分基础组件和复杂组件，同等地对待它们。复杂的逻辑往往都在组件的递归调用中完成了。
- 向已有的结构中新增组件变得很容易。
- 组件通用化意味着任意复杂组件可以包含任意类型的组件，如果需要对组件的类型做限定，就必须在运行时检查。

## 实现

- 考虑是否要在子节点中增加对其父节点的引用。
- 为了使基础组件和复杂组件对客户端透明，必须在 `Component` 接口中定义尽量多的接口，并提供默认实现。这会使得某些组件不得不继承对其没有意义的接口，例如简单组件没有子节点，管理子节点的接口显然是无意义的。
- 在安全性和透明性之间做取舍。把子节点管理的接口定义在 `Component` 中，可以使客户端一致对待基础组件和复杂组件，但是增加子节点的方法 `add(Component component)` 可能默认实现是抛出一个 `UnsupportedOperationException`，那么客户端在调用这个方法时就可能需要处理这个异常。而如果把组件管理的接口只定义在复杂组件上，那么就失去了组件对客户端的透明性。
- 如果某些从父节点到子节点的递归计算比较耗时，可以考虑在父节点缓存计算结果。当然，当子节点改变时，应该使相应父节点的缓存失效，这可能要求子节点维护一个到父节点的引用。
- 为存储子节点选择合适的数据结构。

## 与其他模式的比较

- 迭代器模式可以用来遍历组合中的对象。
